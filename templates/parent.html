{% extends "base.html" %}

{% block content %}
<style>
    /* Status Badges */
    .status-badge { font-size: 0.7em; padding: 4px 8px; border-radius: 4px; margin-left: 10px; transition: all 0.3s ease; }
    .status-online { background: #22c55e; color: white; box-shadow: 0 0 10px #22c55e; }
    .status-offline { background: #ef4444; color: white; }

    /* Buttons & Interaction */
    .btn-snapshot { background: #cf6679 !important; color: black !important; font-weight: bold; margin-top: 10px; transition: transform 0.1s; cursor: pointer; border: none; }
    .btn-snapshot:active { transform: scale(0.95); }

    /* Library UI Management */
    .playlist-deck { margin-top: 15px; padding-top: 15px; border-top: 1px solid #334155; }
    .playlist-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .playlist-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }

    .library-select {
        width: 100%; background: #0f172a; border: 1px solid #334155; color: #f8fafc;
        padding: 10px; border-radius: 8px; font-size: 0.9em; cursor: pointer; outline: none;
    }
    .library-select:focus { border-color: #38bdf8; }

    /* Mode Toggles (Day/Night) */
    .mode-toggle-group { display: flex; gap: 8px; margin-top: 10px; }
    .btn-mode { flex: 1; padding: 10px; font-size: 0.8em; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; cursor: pointer; transition: 0.2s; font-weight: bold; }

    .active-day { border-color: #fbbf24 !important; color: #fbbf24 !important; background: rgba(251, 191, 36, 0.1) !important; box-shadow: 0 0 10px rgba(251, 191, 36, 0.2); }
    .active-night { border-color: #818cf8 !important; color: #818cf8 !important; background: rgba(129, 140, 248, 0.1) !important; box-shadow: 0 0 10px rgba(129, 140, 248, 0.2); }

    /* Layout & Viewports */
    .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: #1e293b; padding: 20px; border-radius: 15px; border: 1px solid #334155; }
    .btn-nav { padding: 10px 18px; background: #334155; color: white; text-decoration: none; border-radius: 8px; font-size: 0.85em; font-weight: bold; }

    .view-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; border: 1px solid #334155; overflow: hidden; position: relative; }
    .view-label { font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: 800; margin-bottom: 4px; display: flex; justify-content: space-between; margin-top: 10px; }

    /* Animation */
    .live-dot { height: 8px; width: 8px; background-color: #ef4444; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    .vol-slider { -webkit-appearance: none; height: 6px; background: #334155; border-radius: 5px; outline: none; }
    .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #38bdf8; border-radius: 50%; cursor: pointer; }
</style>

<div class="dashboard-grid" style="max-width: 1200px; margin: auto; padding: 20px;">
    <div class="nav-header">
        <div>
            <h1 style="margin:0; color: #f8fafc;">üõ°Ô∏è Sentinel Hub</h1>
            <div id="connection-status" style="color: #38bdf8; font-size: 0.8em; margin-top: 4px; font-weight: bold;">‚óè SYSTEM LIVE & ENCRYPTED</div>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="#" class="btn-nav" style="background: #38bdf8; color: #0f172a;" onclick="if(window.ParentVault) ParentVault.openLibraryManager()">üéµ MANAGE LIBRARY</a>
            <a href="/parent/enroll" class="btn-nav" style="background: #10b981; color: white;">‚ûï ENROLL CHILD</a>
        </div>
    </div>

    <div class="kids-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px;">
        {% for id, data in kids.items() %}
        <div class="kid-tile" id="tile-{{ id }}" data-kid-id="{{ id }}" style="background: #1e293b; padding: 25px; border-radius: 20px; border: 1px solid #334155;">

            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <h3 style="margin: 0; color: #f8fafc; font-size: 1.4em;">
                    {{ data.name }}
                    <small style="color: #64748b; display: block; font-size: 0.55em; font-family: monospace; text-transform: uppercase;">ID: {{ id }}</small>
                </h3>
                <span id="status-badge-{{ id }}" class="status-badge status-offline">OFFLINE</span>
            </div>

            <span class="view-label">üì∫ YouTube Mirror</span>
            <div id="mirror-wrapper-{{ id }}" class="view-container" style="margin-bottom: 5px;">
                <div id="yt-mirror-{{ id }}" style="width: 100%; height: 100%;"></div>
                <div id="mirror-placeholder-{{ id }}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #020617; z-index: 10; pointer-events: none;">
                    <small style="color: #38bdf8; font-weight: bold; letter-spacing: 1px;">[ WAITING FOR SYNC ]</small>
                </div>
            </div>

            <div style="width: 100%; height: 4px; background: #0f172a; border-radius: 2px; overflow: hidden; margin-bottom: 10px;">
                <div id="progress-bar-{{ id }}" style="width: 0%; height: 100%; background: #38bdf8; transition: width 0.5s linear;"></div>
            </div>

            <span class="view-label">
                <span>üì∑ Live Camera Feed</span>
                <span id="live-indicator-{{ id }}" style="display: none; color: #ef4444; font-size: 0.9em;"><span class="live-dot"></span>LIVE</span>
            </span>
            <div id="snapshot-wrapper-{{ id }}" class="view-container" style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center;">
                <img id="cam-feed-{{ id }}" style="width: 100%; height: 100%; object-fit: cover; display: none;" src="">
                <div id="placeholder-{{ id }}" style="color: #475569; text-align: center;">
                    <span style="font-size: 1.5rem; display: block;">üì∑</span>
                    <small>Connecting to Cam...</small>
                </div>
            </div>

            <div class="controls" style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button style="flex: 1; padding: 10px; background: #334155; color: white; border-radius: 8px; border: none; cursor: pointer;"
                            onclick="sendCmd('{{ id }}', 'seek_relative', { seconds: -10 })">‚è™ -10s</button>

                    <button style="flex: 1.5; padding: 10px; background: #10b981; color: white; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;"
                            onclick="sendCmd('{{ id }}', 'play')">‚ñ∂ PLAY</button>

                    <button style="flex: 1.5; padding: 10px; background: #475569; color: white; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;"
                            onclick="sendCmd('{{ id }}', 'pause')">‚è∏ PAUSE</button>

                    <button style="flex: 1; padding: 10px; background: #334155; color: white; border-radius: 8px; border: none; cursor: pointer;"
                            onclick="sendCmd('{{ id }}', 'seek_relative', { seconds: 10 })">10s ‚è©</button>
                </div>

                <div style="display: flex; align-items: center; gap: 10px; background: #0f172a; padding: 8px 12px; border-radius: 8px; border: 1px solid #334155;">
                    <span style="font-size: 0.8em;">üîä</span>
                    <input type="range" id="volume-slider-{{ id }}" class="vol-slider" min="0" max="100" value="80"
                           style="flex: 1;"
                           oninput="sendCmd('{{ id }}', 'volume_set', { level: parseInt(this.value) })">
                </div>

                <button class="btn-snapshot" style="padding: 14px; border-radius: 8px;" onclick="sendCmd('{{ id }}', 'request_snapshot')">
                    üì∏ SAVE HI-RES SNAPSHOT
                </button>

                <div class="playlist-deck">
                    <div class="playlist-group">
                        <label class="playlist-label">‚òÄÔ∏è Day Mode Library</label>
                        <select class="library-select" id="sel-day-{{ id }}" onchange="assignFromLibrary('{{ id }}', 'day', this.value)">
                            <option value="">-- Select Library --</option>
                            {% for lib_id, pl in library.items() %}
                                <option value="{{ lib_id }}" {% if data.get('playlists', {}).get('day') == lib_id %}selected{% endif %}>{{ pl.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="playlist-group">
                        <label class="playlist-label">üåô Night Mode Library</label>
                        <select class="library-select" id="sel-night-{{ id }}" onchange="assignFromLibrary('{{ id }}', 'night', this.value)">
                            <option value="">-- Select Library --</option>
                            {% for lib_id, pl in library.items() %}
                                <option value="{{ lib_id }}" {% if data.get('playlists', {}).get('night') == lib_id %}selected{% endif %}>{{ pl.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mode-toggle-group">
                        <button id="btn-day-{{ id }}" class="btn-mode {% if not data.get('settings', {}).get('night_mode', False) %}active-day{% endif %}" onclick="switchMode('{{ id }}', 'day')">‚òÄÔ∏è DAY</button>
                        <button id="btn-night-{{ id }}" class="btn-mode {% if data.get('settings', {}).get('night_mode', False) %}active-night{% endif %}" onclick="switchMode('{{ id }}', 'night')">üåô NIGHT</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://www.youtube.com/iframe_api"></script>

<script src="{{ url_for('static', filename='js/parent/parent_socket.js') }}"></script>
<script src="{{ url_for('static', filename='js/parent/parent_vault.js') }}"></script>
<script src="{{ url_for('static', filename='js/parent/parent_mirror.js') }}"></script>
<script src="{{ url_for('static', filename='js/parent/parent_stream.js') }}"></script>

<script>
    /**
     * [AUDIT] Improved Assignment Logic
     * Bridges UI with ParentVault to ensure video/playlist detection works.
     */
    async function assignFromLibrary(kidId, mode, libId) {
        if (!libId) return;

        const select = document.getElementById(`sel-${mode}-${kidId}`);

        try {
            // Check if our service module is ready
            if (window.ParentVault && typeof window.ParentVault.assignPlaylist === 'function') {
                console.log(`[üìö] Triggering real-time assignment for ${kidId}`);
                await window.ParentVault.assignPlaylist(kidId, mode, libId);

                // Success visual indicator
                select.style.borderColor = "#10b981";
                setTimeout(() => { select.style.borderColor = "#334155"; }, 1500);
            } else {
                // Fallback to direct fetch if ParentVault isn't initialized
                console.warn("[‚ö†Ô∏è] ParentVault.assignPlaylist not found. Executing raw fallback.");
                await fetch('/parent/api/library/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kid_id: kidId, mode: mode, library_id: libId })
                });
            }
        } catch (err) {
            console.error("[‚ùå] Library Assignment Error:", err);
            select.style.borderColor = "#ef4444";
        }
    }

    /**
     * Toggles between Day and Night profiles for a child
     */
    function switchMode(kidId, mode) {
        const isNight = (mode === 'night');

        // Immediate UI Update
        document.getElementById(`btn-day-${kidId}`).classList.toggle('active-day', !isNight);
        document.getElementById(`btn-night-${kidId}`).classList.toggle('active-night', isNight);

        // Command Relay to Tablet
        if (window.sendCmd) {
            window.sendCmd(kidId, 'switch_mode', { night_mode: isNight });
        }
    }
</script>
{% endblock %}